/**
 * Vulnerability Detail Panel - Detailed view in drawer format
 */

import {
  Box,
  Typography,
  Chip,
  Divider,
  Stack,
  IconButton,
  Tooltip,
  Paper,
  alpha,
  useTheme,
} from "@mui/material";
import {
  Close as CloseIcon,
  OpenInNew as OpenInNewIcon,
  ContentCopy as CopyIcon,
} from "@mui/icons-material";
import { motion } from "framer-motion";
import { toast } from "react-toastify";
import type { FlattenedVulnerability } from "../types/vulnerability";

interface VulnerabilityDetailPanelProps {
  vulnerability: FlattenedVulnerability;
  onClose: () => void;
}

export default function VulnerabilityDetailPanel({
  vulnerability,
  onClose,
}: VulnerabilityDetailPanelProps) {
  const theme = useTheme();

  const getSeverityColor = (severity: string) => {
    switch (severity.toUpperCase()) {
      case "CRITICAL":
        return theme.palette.error.main;
      case "HIGH":
        return theme.palette.warning.main;
      case "MEDIUM":
        return theme.palette.info.main;
      case "LOW":
        return theme.palette.success.main;
      default:
        return theme.palette.grey[500];
    }
  };

  const handleCopy = (text: string, label: string) => {
    navigator.clipboard.writeText(text);
    toast.success(`${label} copied to clipboard`);
  };

  const InfoSection = ({
    title,
    children,
  }: {
    title: string;
    children: React.ReactNode;
  }) => (
    <Box sx={{ mb: 3 }}>
      <Typography
        variant="subtitle2"
        fontWeight={700}
        sx={{
          mb: 1.5,
          color: "primary.main",
          textTransform: "uppercase",
          fontSize: "0.75rem",
          letterSpacing: 1,
        }}
      >
        {title}
      </Typography>
      {children}
    </Box>
  );

  const InfoRow = ({
    label,
    value,
    copyable,
  }: {
    label: string;
    value: React.ReactNode;
    copyable?: string;
  }) => (
    <Box
      sx={{
        display: "flex",
        justifyContent: "space-between",
        alignItems: "center",
        py: 1,
        "&:not(:last-child)": {
          borderBottom: 1,
          borderColor: "divider",
        },
      }}
    >
      <Typography
        variant="body2"
        color="text.secondary"
        sx={{ fontWeight: 500, minWidth: 140 }}
      >
        {label}
      </Typography>
      <Box sx={{ display: "flex", alignItems: "center", gap: 1, flex: 1 }}>
        <Box sx={{ flex: 1, textAlign: "right" }}>{value}</Box>
        {copyable && (
          <Tooltip title="Copy">
            <IconButton
              size="small"
              onClick={() => handleCopy(copyable, label)}
              sx={{ opacity: 0.6, "&:hover": { opacity: 1 } }}
            >
              <CopyIcon fontSize="small" />
            </IconButton>
          </Tooltip>
        )}
      </Box>
    </Box>
  );

  return (
    <motion.div
      initial={{ opacity: 0, x: 20 }}
      animate={{ opacity: 1, x: 0 }}
      exit={{ opacity: 0, x: 20 }}
      transition={{ duration: 0.3 }}
      style={{ height: "100%", overflow: "auto" }}
    >
      <Box sx={{ p: 3 }}>
        {/* Header */}
        <Box
          sx={{
            display: "flex",
            justifyContent: "space-between",
            alignItems: "flex-start",
            mb: 3,
          }}
        >
          <Box sx={{ flex: 1, pr: 2 }}>
            <Box sx={{ display: "flex", alignItems: "center", gap: 1, mb: 1 }}>
              <Typography variant="h5" fontWeight={700}>
                {vulnerability.cve}
              </Typography>
              {vulnerability.link && (
                <Tooltip title="Open CVE Link">
                  <IconButton
                    size="small"
                    onClick={() => window.open(vulnerability.link, "_blank")}
                  >
                    <OpenInNewIcon fontSize="small" />
                  </IconButton>
                </Tooltip>
              )}
            </Box>
            <Box sx={{ display: "flex", gap: 1, flexWrap: "wrap" }}>
              <Chip
                label={vulnerability.severity.toUpperCase()}
                size="small"
                sx={{
                  fontWeight: "bold",
                  bgcolor: alpha(
                    getSeverityColor(vulnerability.severity),
                    0.15
                  ),
                  color: getSeverityColor(vulnerability.severity),
                }}
              />
              <Chip
                label={`CVSS: ${vulnerability.cvss?.toFixed(1) || "N/A"}`}
                size="small"
                variant="outlined"
              />
              <Chip
                label={vulnerability.kaiStatus || "N/A"}
                size="small"
                color={
                  vulnerability.kaiStatus === "Valid" ? "success" : "default"
                }
                variant="outlined"
              />
            </Box>
          </Box>
          <Tooltip title="Close">
            <IconButton onClick={onClose} sx={{ mt: -1 }}>
              <CloseIcon />
            </IconButton>
          </Tooltip>
        </Box>

        <Divider sx={{ mb: 3 }} />

        {/* Description */}
        {vulnerability.description && (
          <InfoSection title="Description">
            <Paper
              variant="outlined"
              sx={{
                p: 2,
                bgcolor: alpha(theme.palette.background.default, 0.5),
              }}
            >
              <Typography variant="body2" sx={{ lineHeight: 1.7 }}>
                {vulnerability.description}
              </Typography>
            </Paper>
          </InfoSection>
        )}

        {/* Location Information */}
        <InfoSection title="Location">
          <Box>
            <InfoRow
              label="Group"
              value={<Chip label={vulnerability.groupName} size="small" />}
              copyable={vulnerability.groupName}
            />
            <InfoRow
              label="Repository"
              value={<Chip label={vulnerability.repoName} size="small" />}
              copyable={vulnerability.repoName}
            />
            <InfoRow
              label="Image"
              value={<Chip label={vulnerability.imageName} size="small" />}
              copyable={vulnerability.imageName}
            />
            {vulnerability.imageCreateTime && (
              <InfoRow
                label="Image Created"
                value={
                  <Typography variant="body2">
                    {new Date(
                      vulnerability.imageCreateTime
                    ).toLocaleDateString()}
                  </Typography>
                }
              />
            )}
          </Box>
        </InfoSection>

        {/* Package Information */}
        <InfoSection title="Package Details">
          <Box>
            <InfoRow
              label="Package"
              value={
                <Typography variant="body2" fontWeight={600}>
                  {vulnerability.packageName}
                </Typography>
              }
              copyable={vulnerability.packageName}
            />
            <InfoRow
              label="Installed Version"
              value={
                <Chip
                  label={vulnerability.packageVersion}
                  size="small"
                  color="warning"
                  variant="outlined"
                />
              }
              copyable={vulnerability.packageVersion}
            />
            {vulnerability.fixDate && (
              <InfoRow
                label="Fixed Version"
                value={
                  <Chip
                    label="Available"
                    size="small"
                    color="success"
                    variant="outlined"
                  />
                }
              />
            )}
            <InfoRow
              label="Package Type"
              value={
                <Typography variant="body2">
                  {vulnerability.packageType}
                </Typography>
              }
            />
            {vulnerability.path && (
              <InfoRow
                label="Path"
                value={
                  <Typography
                    variant="body2"
                    sx={{
                      fontFamily: "monospace",
                      fontSize: "0.75rem",
                      wordBreak: "break-all",
                    }}
                  >
                    {vulnerability.path}
                  </Typography>
                }
                copyable={vulnerability.path}
              />
            )}
          </Box>
        </InfoSection>

        {/* Risk Factors */}
        {Object.keys(vulnerability.riskFactors || {}).length > 0 && (
          <InfoSection title="Risk Factors">
            <Box sx={{ display: "flex", gap: 1, flexWrap: "wrap" }}>
              {Object.keys(vulnerability.riskFactors).map((factor) => (
                <Chip
                  key={factor}
                  label={factor}
                  size="small"
                  color="error"
                  variant="outlined"
                />
              ))}
            </Box>
          </InfoSection>
        )}

        {/* Dates & Timeline */}
        <InfoSection title="Timeline">
          <Box>
            {vulnerability.published && (
              <InfoRow
                label="Published"
                value={
                  <Typography variant="body2">
                    {new Date(vulnerability.published).toLocaleDateString()}
                  </Typography>
                }
              />
            )}
            {vulnerability.fixDate && (
              <InfoRow
                label="Fix Available"
                value={
                  <Typography variant="body2">
                    {new Date(vulnerability.fixDate).toLocaleDateString()}
                  </Typography>
                }
              />
            )}
            {vulnerability.layerTime && (
              <InfoRow
                label="Layer Time"
                value={
                  <Typography variant="body2">
                    {new Date(vulnerability.layerTime).toLocaleDateString()}
                  </Typography>
                }
              />
            )}
          </Box>
        </InfoSection>

        {/* Additional Details */}
        <InfoSection title="Additional Information">
          <Box>
            <InfoRow
              label="Status"
              value={<Chip label={vulnerability.status} size="small" />}
            />
            {vulnerability.type && (
              <InfoRow
                label="Type"
                value={
                  <Typography variant="body2">{vulnerability.type}</Typography>
                }
              />
            )}
            {vulnerability.cause && (
              <InfoRow
                label="Cause"
                value={
                  <Typography variant="body2">{vulnerability.cause}</Typography>
                }
              />
            )}
            {vulnerability.exploit && (
              <InfoRow
                label="Exploit"
                value={
                  <Chip
                    label={vulnerability.exploit}
                    size="small"
                    color="error"
                  />
                }
              />
            )}
            {vulnerability.owner && (
              <InfoRow
                label="Owner"
                value={
                  <Typography variant="body2">{vulnerability.owner}</Typography>
                }
              />
            )}
            {vulnerability.advisoryType && (
              <InfoRow
                label="Advisory Type"
                value={
                  <Typography variant="body2">
                    {vulnerability.advisoryType}
                  </Typography>
                }
              />
            )}
          </Box>
        </InfoSection>

        {/* Vector String */}
        {vulnerability.vecStr && (
          <InfoSection title="CVSS Vector">
            <Paper
              variant="outlined"
              sx={{
                p: 2,
                bgcolor: alpha(theme.palette.background.default, 0.5),
              }}
            >
              <Typography
                variant="body2"
                sx={{ fontFamily: "monospace", fontSize: "0.75rem" }}
              >
                {vulnerability.vecStr}
              </Typography>
            </Paper>
          </InfoSection>
        )}

        {/* Applicable Rules */}
        {vulnerability.applicableRules &&
          vulnerability.applicableRules.length > 0 && (
            <InfoSection title="Applicable Rules">
              <Stack spacing={0.5}>
                {vulnerability.applicableRules.map((rule, idx) => (
                  <Chip
                    key={idx}
                    label={rule}
                    size="small"
                    variant="outlined"
                  />
                ))}
              </Stack>
            </InfoSection>
          )}
      </Box>
    </motion.div>
  );
}
