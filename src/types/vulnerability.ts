/**
 * Type definitions for Security Vulnerability Dashboard
 * Represents the hierarchy: Root → Groups → Repos → Images → Vulnerabilities
 */

/**
 * Individual security vulnerability (CVE)
 */
export interface Vulnerability {
  cve: string;
  severity: "critical" | "high" | "medium" | "low" | "negligible";
  cvss: number;
  status: string;
  kaiStatus: string;
  cause: string;
  description: string;
  vecStr: string;
  exploit: string;
  riskFactors: Record<string, Record<string, never>>;
  link: string;
  type: string;
  packageName: string;
  packageVersion: string;
  packageType: string;
  layerTime: string;
  published: string;
  fixDate: string;
  applicableRules: string[];
  owner: string;
  advisoryType: string;
  path: string;
}

/**
 * Container image with vulnerabilities
 */
export interface Image {
  name: string;
  createTime?: string;
  buildType?: string;
  vulnerabilities: Vulnerability[];
  summary?: {
    critical?: number;
    high?: number;
    medium?: number;
    low?: number;
    negligible?: number;
  };
}

/**
 * Repository containing multiple images
 */
export interface Repository {
  name: string;
  images: Record<string, Image>;
}

/**
 * Group containing multiple repositories
 */
export interface Group {
  name: string;
  repos: Record<string, Repository>;
}

/**
 * Root data structure
 */
export interface VulnerabilityData {
  name: string;
  groups: Record<string, Group>;
}

/**
 * Flattened vulnerability with metadata for efficient querying
 */
export interface FlattenedVulnerability extends Vulnerability {
  id: string; // Unique composite ID
  groupName: string;
  repoName: string;
  imageName: string;
  imageCreateTime?: string;
  // Computed fields for quick filtering
  publishedDate?: Date;
  fixedDate?: Date;
  layerDate?: Date;
}

/**
 * Filter criteria
 */
export interface FilterCriteria {
  searchQuery?: string;
  severities?: string[];
  kaiStatuses?: string[];
  cvssRange?: [number, number];
  packageNames?: string[];
  packageTypes?: string[];
  dateRange?: {
    start?: Date;
    end?: Date;
  };
  groups?: string[];
  repos?: string[];
  hasExploit?: boolean;
  hasFix?: boolean;
  // Analysis filters
  excludeInvalidNoRisk?: boolean; // "Analysis" button
  excludeAiInvalidNoRisk?: boolean; // "AI Analysis" button
}

/**
 * Aggregated metrics for dashboard
 */
export interface VulnerabilityMetrics {
  total: number;
  bySeverity: Record<string, number>;
  byKaiStatus: Record<string, number>;
  byRiskFactor: Record<string, number>;
  byPackageType: Record<string, number>;
  cvssDistribution: {
    range: string;
    count: number;
  }[];
  timeline: {
    month: string;
    count: number;
  }[];
  topPackages: {
    name: string;
    count: number;
  }[];
  topRepos: {
    name: string;
    count: number;
  }[];
  criticalHighlights: FlattenedVulnerability[];
}

/**
 * Pagination state
 */
export interface PaginationState {
  page: number;
  pageSize: number;
  total: number;
}

/**
 * Sort configuration
 */
export interface SortConfig {
  field: keyof FlattenedVulnerability;
  direction: "asc" | "desc";
}

/**
 * User preferences stored in localStorage
 */
export interface UserPreferences {
  theme: "light" | "dark";
  pageSize: number;
  defaultFilters: Partial<FilterCriteria>;
  hiddenDashboardSections: string[];
  favoriteVulnerabilities: string[];
}

/**
 * Data loading state
 */
export interface DataLoadingState {
  status: "idle" | "loading" | "processing" | "ready" | "error";
  progress: number; // 0-100
  message: string;
  error?: string;
}

/**
 * Export format options
 */
export type ExportFormat = "csv" | "json" | "excel";

/**
 * Comparison item for side-by-side analysis
 */
export interface ComparisonItem {
  id: string;
  vulnerability: FlattenedVulnerability;
}
